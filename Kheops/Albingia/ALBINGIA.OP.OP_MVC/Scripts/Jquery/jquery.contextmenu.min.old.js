(function(n){function t(){return!1}n.fn.contextmenu=function(i){function tt(n){var t;if(o&&o==n.name)return!1;for(t in f)it(t,!n.disable);for(t=0;t<n.items.length;t++)it(n.items[t],n.disable);o=n.name}function it(n,t){var i=f[n];i.className=(i.disable=i.lastChild.disabled=t)?"b-m-idisable":"b-m-item"}function ut(t,i){p=i,nt.call(u.cmroot,{left:t.pageX,top:t.pageY},0);n(document).one("mousedown",v)}var y,r,rt;i=n.extend({alias:"cmroot",width:150},i);var o=null,p=null,u={},f={},s={},e=[],w="<div class='b-m-$[type]' unselectable=on><nobr unselectable=on><img src='$[icon]' align='absmiddle'/><span unselectable=on>$[text]<\/span><\/nobr><\/div>",h=n("<div/>").addClass("b-m-mpanel").attr("unselectable","on").css("display","none"),c=n("<div/>").addClass("b-m-item").attr("unselectable","on"),b=n("<div/>").addClass("b-m-split"),l=function(i){return u[i.alias]=this,this.gidx=i.alias,this.id=i.alias,i.disable&&(this.disable=i.disable,this.className="b-m-idisable"),n(this).width(i.width).click(t).mousedown(t).appendTo(n("body")),i=null,this},a=function(n){var t=this;return t.title=n.text,t.idx=n.alias,t.gidx=n.gidx,t.data=n,t.innerHTML=w.replace(/\$\[([^\]]+)\]/g,function(){return n[arguments[1]]}),n.disable&&(t.disable=n.disable,t.className="b-m-idisable"),n.items&&(t.group=!0),n.action&&(s[n.alias]=n.action),f[n.alias]=t,t=n=null,this},k=function(i,r){for(var e=null,f=0;f<r.length;f++)r[f].type=="splitLine"?e=b.clone()[0]:(r[f].gidx=i,r[f].type=="group"?(l.apply(h.clone()[0],[r[f]]),arguments.callee(r[f].alias,r[f].items),r[f].type="arrow",e=a.apply(c.clone()[0],[r[f]])):(r[f].type="ibody",e=a.apply(c.clone()[0],[r[f]]),n(e).click(function(){return this.disable||(n.isFunction(s[this.idx])&&s[this.idx].call(this,p),v()),!1})),n(e).bind("contextmenu",t).hover(d,g)),u[i].appendChild(e),e=r[f]=r[f].items=null;i=r=null},d=function(){if(this.disable)return!1;if(v.call(u[this.gidx]),this.group){var i=n(this).offset(),r=n(this).outerWidth();nt.apply(u[this.idx],[i,r])}return this.className="b-m-ifocus",!1},g=function(){return this.disable?!1:(this.group||(this.className="b-m-item"),!1)},nt=function(t,i){var f=n("body").width(),o=document.documentElement.clientHeight,r=n(this).outerWidth(),u=n(this).outerHeight();t.left=t.left+i+r>f?t.left-r<0?0:t.left-r:t.left+i,t.top=t.top+u>o?t.top-u+(i>0?25:0)<0?0:t.top-u+(i>0?25:0):t.top,n(this).css(t).show(),e.push(this.gidx)},v=function(){for(var n=null,t=e.length-1;t>=0;t--){if(e[t]==this.gidx)break;n=e.pop(),u[n].style.display="none",f[n]&&(f[n].className="b-m-item")}};return y=n("#"+i.alias),r=null,y.length==0?(r=l.apply(h.clone()[0],[i]),r.applyrule=tt,r.showMenu=ut,k(i.alias,i.items)):r=y[0],rt=n(this).each(function(){return n(this).bind("contextmenu",function(t){var u=i.onContextMenu&&n.isFunction(i.onContextMenu)?i.onContextMenu.call(this,t):!0;return u&&(i.onShow&&n.isFunction(i.onShow)&&i.onShow.call(this,r),r.showMenu(t,this)),!1})}),i.rule&&tt(i.rule),h=c=b=w=l=a=null,k=d=g=null,rt}})(jQuery)